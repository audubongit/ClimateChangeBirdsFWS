

## add climate vulnerablity information to species trends

library(data.table)
library(plyr)
library(dplyr)
library(tidyr)
library(stringr)
library(tools)

setwd('Z:/Climate_2_0/Climate_USFWS_Briefs/')

## ---------- add vulnerability information to two top modes --------- ##
# read in vulnerability and group info
vuln <- fread('inputs/all_species_vulnerability_capped.csv') %>%  
  select(scientific_name=Scientific.Name, species=Code, scenario=Scenario, season=Season, 
         vulnerability=Vulnerability, ploss=Prop.Loss, pgain=Prop.Gain) %>%
  filter(scenario=='2.0 deg C') 
group <- fread('Z:/Climate_2_0/data_tables/phenology_table_all_species_final_groups.csv') %>%
  select(species=Code, summer=Summer.Group, winter=Winter.Group) %>%
  gather(season, group, summer:winter) 

# read mode fitered list
master <- fread('outputs/all_refuges_mode_tables_filter.csv') %>% # filtered by county lists, introduced species
  filter(year==2055) %>% # remove other years
  inner_join(vuln) %>% 
  inner_join(group) %>%
  distinct() 

# check number of scenarios per species
foo <- master %>% group_by(refuge_name, species, season, year) %>%
  mutate(num=length(scenario)) # should be a max of 6: 2 modes x 3 scenarios

fwrite(master, 'outputs/all_refuges_mode_tables_filter_vulnerability.csv')

## ---------- add vulnerability information to top mode/trend --------- ##
# read mode fitered list
top <- fread('outputs/species_filtered_top_mode_trend_fws.csv') %>% # filtered by county lists, introduced species
  filter(year==2055) %>%
  inner_join(vuln) %>% 
  inner_join(group) %>%
  distinct() 

fwrite(top, 'outputs/species_filtered_top_mode_trend_fws_vulnerability.csv')

  
