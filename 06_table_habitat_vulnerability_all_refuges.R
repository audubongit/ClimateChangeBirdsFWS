
## create table of vulnerability counts by habitat groups across the NWRS

library(data.table)
library(dplyr)
library(tidyr)

figure_dir <- "Z:/Climate_2_0/Climate_USFWS_Briefs"

# species vulnerability and habitat
hab_levels <- c('arctic', 'boreal_forests', 'grasslands', 'western_forests', 'waterbirds', 
                'urban_suburban', 'generalists', 'aridlands', 'marshlands', 
                'subtropical_forests', 'eastern_forests', 'coastal')
hab_labels <- c('A', 'F-B', 'G', 'F-W', 'W', 'U', 'Gen', 'D', 'M', 'F-S', 'F-E', 'C')
spp_order <- fread('Z:/eBird/eBird_Taxonomy_v2018.csv') %>% rename_all(tolower) %>%
  select(taxon_order, species_name=primary_com_name)
spp_vuln <- fread('Z:/Climate_2_0/all_results/all_species_vulnerability_capped.csv') %>%
  rename_all(tolower) %>%
  select(species_name=common.name, species=code, season, scenario, vulnerability, group) %>%
  mutate(scenario=as.numeric(gsub('[^0-9]', '', scenario)),
         group=factor(group, levels=hab_levels, labels=hab_labels),
         species_name=gsub('Le Conte', 'LeConte', species_name),
         vulnerability=factor(vulnerability, levels=c('N', 'L', 'M', 'H'),
                              labels=c('Neutral', 'Low', 'Moderate', 'High'))) %>%
  filter(scenario==20 & group!='U') %>% inner_join(spp_order)

# species trends
modes <- fread('Z:/Climate_2_0/Climate_USFWS_Briefs/outputs/species_filtered_top_mode_trend_fws.csv') %>%
  filter(year==2055) %>%
  distinct()

species_tb <- fread('Z:/Climate_2_0/Climate_USFWS_Briefs/outputs/all_refuges_mode_tables_filter.csv') %>%
  filter(year==2055) %>% group_by(refuge_id, species, season) %>%
  distinct(refuge_id, species, season, trend, n, prop_cells) %>%
  mutate(percent_of_zone=round(prop_cells, 2)) %>%
  filter(percent_of_zone>0) %>% 
  filter(n>1) %>%
  ungroup() %>%
  inner_join(spp_vuln) %>%
  mutate(image=paste0(figure_dir, '/Figures/species_trends/', species, '_', gsub(' ', '', refuge_id), '_', season, '.png'),
         season=gsub('(^|[[:space:]])([[:alpha:]])', '\\1\\U\\2', season, perl=TRUE)) %>%
  arrange(refuge_id, taxon_order, season) %>%
  select(refuge_id, species, species_name, group, season, vulnerability, image) %>%
  distinct()

# save
fwrite(species_tb, 'Z:/Climate_2_0/Climate_USFWS_Briefs/inputs/refuges_species_table_filtered.csv')
